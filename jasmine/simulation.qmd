---
title: "simulation testing"
format: html
editor: visual
---

Simulating for three clusters.

## Initial Issues

```{r}
# creating function for ease of comparison
plot_clusters <- function(n, covariance, desired_k, start_seed, test_fit, subsample_prop, add_sample = 0){
  
  # simulate data with desire clusters
  data <- simulate_mvn(n = n, 
                     covariance = covariance, 
                     desired_k = desired_k, 
                     start_seed = start_seed)
  
  # add index
  data$index <- 1:nrow(data)

  # plot data
  initial_plot <- data |>
    ggplot(aes(x = V1,
               y = V2)) + 
    geom_point()
  
  fit_plots <- lapply(test_fit, function(k){
    
    set.seed(start_seed + add_sample)
                       
    # sample
    random_sample <- data |>
      filter(index %in% sample(index, subsample_prop * nrow(data))) 
    
    # use kmeans
    k_model <- k_means(num_clusters = k) |> 
    fit(~ V1 + V2, data = random_sample) 
    
    # get clusters
    fitdata <- k_model |>
    augment(random_sample) 
    
    
    # plot
    fitdata |>
      ggplot(aes(x = V1, y = V2, color = .pred_cluster)) + 
      geom_point() +
      labs(title = paste("k =", k))})
  
  # name elements
  names(fit_plots) <- paste0("k_", test_fit)
  
  # return plots
  return(list(initial_plot = initial_plot,
              fit_plots = fit_plots))}
```

```{r}
#| eval: false
# simulate data with three clusters and fit 3
initial <- plot_clusters(n = 100, 
                         covariance = 0.8, 
                         desired_k = 3, 
                         start_seed = 123, 
                         test_fit = 2:5,
                         subsample_prop = 0.8)

# plots
initial$initial_plot
initial$fit_plot$k_2
initial$fit_plot$k_3
initial$fit_plot$k_4
initial$fit_plot$k_5
```

```{r}
#| eval: false
# creating function for ease of comparing similarity scores
quick_score <- function(n, 
                        covariance, 
                        desired_k,
                        start_seed, 
                        test_fit,
                        subsample_prop,
                        num_subsamples){
  # simulate data
  data <- simulate_mvn(n = n, 
                       covariance = covariance, 
                       desired_k = desired_k,
                       start_seed = start_seed)
  
  # get score matrix
  purrr::map_dfr(test_fit, ~{mean_matrix_test <- mean_matrix(data = data, k = .x,
                                                             subsample_prop = subsample_prop,
                                                             num_subsamples = num_subsamples,
                                                             start_seed = start_seed)
  
  # create tibble of scores
  tibble(k =.x,
         score = similarity_score(mean_matrix_test))})}

```

**Example 1: (Variance = 0.01)**

```{r}
# using own data
data <- simulate_mvn(n = 100, 
                     covariance = 0.01, 
                     desired_k = 3, 
                     start_seed = 123)

data |>
  ggplot(aes(x = V1, y = V2)) +
  geom_point()

# SEED: 123
initial <- plot_clusters(n = 100, 
                         covariance = 0.01, 
                         desired_k = 3, 
                         start_seed = 123, 
                         test_fit = 2:5,
                         subsample_prop = 0.9)

# plots
initial$fit_plot$k_3
initial$fit_plot$k_4

# SEED: 123 + second sample
initial <- plot_clusters(n = 100, 
                         covariance = 0.01, 
                         desired_k = 3, 
                         start_seed = 123, 
                         test_fit = 2:5,
                         subsample_prop = 0.9,
                         add_sample = 1)

# plots
initial$fit_plot$k_3
initial$fit_plot$k_4

# SEED: 123 + third sample
initial <- plot_clusters(n = 100, 
                         covariance = 0.01, 
                         desired_k = 3, 
                         start_seed = 123, 
                         test_fit = 2:5,
                         subsample_prop = 0.9,
                         add_sample = 2)

# plots
initial$fit_plot$k_3
initial$fit_plot$k_4
```

```{r}
# subsamples = 25
simulation_scores(data = data,
                  n = 100,
                  covariance = 0.01,
                  desired_k = 3, 
                  min_k = 2,
                  max_k = 5,
                  subsample_prop = 0.9, 
                  num_subsamples = 25,
                  start_seed = 123)

# subsamples = 35
simulation_scores(data = data,
                  n = 100,
                  covariance = 0.01,
                  desired_k = 3, 
                  min_k = 2,
                  max_k = 5,
                  subsample_prop = 0.9, 
                  num_subsamples = 35,
                  start_seed = 123)
```

```{r}
# using own data
data <- simulate_mvn(n = 100, 
                     covariance = 0.01, 
                     desired_k = 3, 
                     start_seed = 123)

data |>
  ggplot(aes(x = V1, y = V2)) +
  geom_point()
```

The data is clearly clustered into three groups, and the lowest similarity score corresponds with **three** clusters.

**Example 2: (Variance = 0.05)**

```{r}
# using own data
data <- simulate_mvn(n = 100, 
                     covariance = 0.05, 
                     desired_k = 3, 
                     start_seed = 123)

data |>
  ggplot(aes(x = V1, y = V2)) +
  geom_point()

# SEED: 123
initial <- plot_clusters(n = 100, 
                         covariance = 0.05, 
                         desired_k = 3, 
                         start_seed = 123, 
                         test_fit = 2:5,
                         subsample_prop = 0.9)

# plots
initial$fit_plot$k_3
initial$fit_plot$k_4


# SEED: 123 + second sample
initial <- plot_clusters(n = 100, 
                         covariance = 0.05, 
                         desired_k = 3, 
                         start_seed = 123, 
                         test_fit = 2:5,
                         subsample_prop = 0.9,
                         add_sample = 1)

# plots
initial$fit_plot$k_3
initial$fit_plot$k_4


# SEED: 123 + third sample
initial <- plot_clusters(n = 100, 
                         covariance = 0.05, 
                         desired_k = 3, 
                         start_seed = 123, 
                         test_fit = 2:5,
                         subsample_prop = 0.9,
                         add_sample = 2)

# plots
initial$fit_plot$k_3
initial$fit_plot$k_4
```

```{r}
# subsamples = 25
simulation_scores(data = data,
                  n = 100,
                  covariance = 0.01,
                  desired_k = 3, 
                  min_k = 2,
                  max_k = 5,
                  subsample_prop = 0.9, 
                  num_subsamples = 25,
                  start_seed = 123)

# subsamples = 30
simulation_scores(data = data,
                  n = 100,
                  covariance = 0.01,
                  desired_k = 3, 
                  min_k = 2,
                  max_k = 5,
                  subsample_prop = 0.9, 
                  num_subsamples = 30,
                  start_seed = 123)

# subsamples = 30
simulation_scores(data = data,
                  n = 100,
                  covariance = 0.01,
                  desired_k = 3, 
                  min_k = 2,
                  max_k = 5,
                  subsample_prop = 0.9, 
                  num_subsamples = 35,
                  start_seed = 123)
```

Despite the data clearly clustering into three groups, the lowest similarity score initially corresponded with **four** clusters not three. After increasing number of subsamples to 35, the lower similarity score was corrected. Looking at the example predicted clusterings, when four clusters is used, there is minimal variation where the extra cluster is found in the top group. We see that when three clusters is used, the top group is split into two and the bottom group is considered one cluster, resulting in greater variation. This could explain why the scores didn't reflect correct cluster assignments.

------------------------------------------------------------------------

## Testing

### Test 1:

Testing number of replications of 50

```{r}
tictoc::tic()
test1 <- repeat_simulations(num_runs = 50,
                            n = 100,
                            covariances = c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9), 
                            desired_k = 3, 
                            min_k = 2,
                            max_k = 10,
                            subsample_prop = 0.9, 
                            num_subsamples = 25,
                            start_seed = 599)
tictoc::toc()
```

```{r}
plotting_results <- function(result){
  # get all unique covariances
  vars <- sort(unique(result$covariance))
  
  # create a plot for each variance
  plots_list <- lapply(vars, function(var){
    result |>
      filter(covariance == var) |>
      ggplot(aes(x = factor(k), y = score)) +
      geom_boxplot(fill = "pink", color = "black") +
      geom_jitter() +
      labs(x = "k",
           y = "score",
           title = paste("Distribution of Score by k (variance =", var, ")")) +
      theme_minimal()
  })
  
  # name each element of the list for easy access
  names(plots_list) <- paste0("var_", vars)
  
  return(plots_list)
}
```

```{r}
plot <- plotting_results(test1)
plot$var_0.05
plot$var_0.1
plot$var_0.2
plot$var_0.3
plot$var_0.4
plot$var_0.5
plot$var_0.6
plot$var_0.7
plot$var_0.8
```

### Test 2:

Testing number of replications of 50 with samp. prop. 0.8

```{r}
tictoc::tic()
test2 <- repeat_simulations(num_runs = 50,
                            n = 100,
                            covariances = c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8), 
                            desired_k = 3, 
                            min_k = 2,
                            max_k = 10,
                            subsample_prop = 0.8, 
                            num_subsamples = 25,
                            start_seed = 123)
tictoc::toc()
```

```{r}
plot <- plotting_results(test2)
plot$var_0.05
plot$var_0.1
plot$var_0.2
plot$var_0.3
plot$var_0.4
plot$var_0.5
plot$var_0.6
plot$var_0.7
plot$var_0.8
```

### Test 3:

Changing subsample proportion to 0.7

```{r}
tictoc::tic()
test3 <- repeat_simulations(num_runs = 50,
                            n = 100,
                            covariances = c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8), 
                            desired_k = 3, 
                            min_k = 2,
                            max_k = 10,
                            subsample_prop = 0.7, 
                            num_subsamples = 25,
                            start_seed = 123)
tictoc::toc()
```

```{r}
plot <- plotting_results(test3)
plot$var_0.05
plot$var_0.1
plot$var_0.2
plot$var_0.3
plot$var_0.4
plot$var_0.5
plot$var_0.6
plot$var_0.7
plot$var_0.8
```

### Test 4:

Increasing number of data points in dataset to 250

```{r}
tictoc::tic()
test4 <- repeat_simulations(num_runs = 50,
                            n = 250,
                            covariances = c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8), 
                            desired_k = 3, 
                            min_k = 2,
                            max_k = 10,
                            subsample_prop = 0.8, 
                            num_subsamples = 10,
                            start_seed = 123)
tictoc::toc()
```

```{r}
plot <- plotting_results(test4)
plot$var_0.05
plot$var_0.1
plot$var_0.2
plot$var_0.3
plot$var_0.4
plot$var_0.5
plot$var_0.6
plot$var_0.7
plot$var_0.8
```

### Test 5:

Seeing how score changes for different variance

```{r}
tictoc::tic()
test5 <- repeat_simulations(num_runs = 1,
                            n = 100,
                            covariances = c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8), 
                            desired_k = 3, 
                            min_k = 2,
                            max_k = 10,
                            subsample_prop = 0.8, 
                            num_subsamples = 25,
                            start_seed = 599)
tictoc::toc()
```

```{r}
ggplot(test5, aes(x = k, y = score)) +
  geom_point() +
  facet_wrap(~ covariance) +
  geom_line() +
  theme_minimal()
```

### Test 6:

Seeing how score changes for different variance

```{r}
tictoc::tic()
test6 <- repeat_simulations(num_runs = 1,
                            n = 100,
                            covariances = c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8), 
                            desired_k = 3, 
                            min_k = 2,
                            max_k = 10,
                            subsample_prop = 0.8, 
                            num_subsamples = 25,
                            start_seed = 466)
tictoc::toc()
```

```{r}
ggplot(test6, aes(x = k, y = score)) +
  geom_point() +
  facet_wrap(~ covariance) +
  geom_line() +
  theme_minimal()
```

### Test 7:

Seeing how score changes for different variance and increased number of observations

```{r}
tictoc::tic()
test7 <- repeat_simulations(num_runs = 1,
                            n = 250,
                            covariances = c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8), 
                            desired_k = 3, 
                            min_k = 2,
                            max_k = 10,
                            subsample_prop = 0.8, 
                            num_subsamples = 25,
                            start_seed = 466)
tictoc::toc()
```

```{r}
ggplot(test7, aes(x = k, y = score)) +
  geom_point() +
  facet_wrap(~ covariance) +
  geom_line() +
  theme_minimal()
```

```{r}
data_check <- simulate_mvn(n = 250, 
                           covariance = 0.05,
                           desired_k = 3,
                           start_seed = 466)

data_check |>
  ggplot(aes(x = V1, y = V2)) +
  geom_point() +
  labs(title = "250 Observations w/ 0.05 Variance")
```

```{r}
data_check1 <- simulate_mvn(n = 250, 
                           covariance = 0.1,
                           desired_k = 3,
                           start_seed = 466)

data_check1 |>
  ggplot(aes(x = V1, y = V2)) +
  geom_point() +
  labs(title = "250 Observations w/ 0.1 Variance")
```

```{r}
data_check2 <- simulate_mvn(n = 250, 
                           covariance = 0.2,
                           desired_k = 3,
                           start_seed = 466)

data_check2 |>
  ggplot(aes(x = V1, y = V2)) +
  geom_point() +
  labs(title = "250 Observations w/ 0.2 Variance")
```
